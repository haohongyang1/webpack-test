import{existsSync as t}from"fs";import s,{defaultOptions as e}from"purgecss";import{ConcatSource as o}from"webpack-sources";import i from"path";function n(t,s){const e=i.extname((o=t).includes("?")?o.split("?").slice(0,-1).join(""):o);var o;return s.includes(e)}function r(t,s,e=(t=>t.resource),o){const n=[];for(const o of Array.from(t.modulesIterable||[])){const t=e(o);t&&s.includes(i.extname(t))&&n.push(t)}return n}const a=[".css",".scss",".styl",".sass",".less"];export default class{constructor(t){this.purgedStats={},this.options=t}apply(t){t.hooks.compilation.tap("PurgeCSS",t=>{this.initializePlugin(t)}),t.hooks.done.tap("PurgeCSS",this.onHooksDone.bind(this))}onHooksDone(t,s){t.hasErrors()?this.options.verbose&&console.warn("purge-webpack-plugin: pausing due to webpack errors"):this.options.rejected&&(t.purged=this.purgedStats)}getAssetsToPurge(t,s){return t.filter(t=>this.options.only?this.options.only.some(s=>t&&t.name.includes(s)):t&&s.includes(t.name))}initializePlugin(s){const e="function"==typeof this.options.paths?this.options.paths():this.options.paths;e.forEach(s=>{if(!t(s))throw new Error(`Path ${s} does not exist.`)}),s.hooks.additionalAssets.tapPromise("PurgeCSS",()=>this.runPluginHook(s,e))}async runPluginHook(t,i){const c=function(t={},s){const e=[];for(const[o,i]of Object.entries(t))n(o,s)&&e.push({name:o,asset:i});return e}(t.assets,[".css"]);for(const n of t.chunks){const{files:l}=n,u=this.getAssetsToPurge(c,l);for(const{name:c,asset:l}of u){const u=i.concat(r(n,this.options.moduleExtensions||[],t=>t.resource)).filter(t=>!a.some(s=>t.endsWith(s))),h={...e,...this.options,content:u,css:[{raw:l.source()}]};"function"==typeof h.whitelist&&(h.whitelist=h.whitelist()),"function"==typeof h.whitelistPatterns&&(h.whitelistPatterns=h.whitelistPatterns()),"function"==typeof h.whitelistPatternsChildren&&(h.whitelistPatternsChildren=h.whitelistPatternsChildren());const p=(await(new s).purge({content:h.content,css:h.css,defaultExtractor:h.defaultExtractor,extractors:h.extractors,fontFace:h.fontFace,keyframes:h.keyframes,output:h.output,rejected:h.rejected,variables:h.variables,whitelist:h.whitelist,whitelistPatterns:h.whitelistPatterns,whitelistPatternsChildren:h.whitelistPatternsChildren}))[0];p.rejected&&(this.purgedStats[c]=p.rejected),t.assets[c]=new o(p.css)}}}}
